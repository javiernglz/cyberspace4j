---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const allPosts = await getCollection('blog');

const categoryCounts: Record<string, number> = {};
const categoryTags: Record<string, Set<string>> = {};

allPosts.forEach(post => {
    const categories = post.data.categories || [];
    const tags = post.data.tags || [];

    categories.forEach(category => {
        if (!categoryCounts[category]) categoryCounts[category] = 0;
        categoryCounts[category]++;

        if (!categoryTags[category]) categoryTags[category] = new Set();
        tags.forEach(tag => categoryTags[category].add(tag));
    });
});

function slugify(text: string) {
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-]+/g, '')
        .replace(/\-\-+/g, '-')
        .trim();
}

const CUSTOM_ORDER = ['red-team', 'blue-team', 'certificaciones', 'docencia'];

const sortedCategories = Object.entries(categoryCounts).sort((a, b) => {
    const slugA = slugify(a[0]);
    const slugB = slugify(b[0]);
    let indexA = CUSTOM_ORDER.indexOf(slugA);
    let indexB = CUSTOM_ORDER.indexOf(slugB);
    if (indexA === -1) indexA = 999;
    if (indexB === -1) indexB = 999;
    return indexA - indexB;
});

const CATEGORY_IMAGES: Record<string, string> = {
    'red-team': '/icons/ninja.png',
    'pentesting': '/icons/ninja.png',
    'hacking': '/icons/ninja.png',
    'blue-team': '/icons/escudo.png',
    'ciberdefensa': '/icons/escudo.png',
    'threat-hunting': '/icons/escudo.png',
    'certificaciones': '/icons/medalla.png',
    'ejptv2': '/icons/medalla.png',
    'ecpptv3': '/icons/medalla.png',
    'docencia': '/icons/pizarra.png',
    'teoria': '/icons/pizarra.png',
    'clases': '/icons/pizarra.png',
    'default': '/icons/pizarra.png'
};

function getCategoryImage(categorySlug: string) {
    return CATEGORY_IMAGES[categorySlug] || CATEGORY_IMAGES['default'];
}
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title={`Categorías - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
        <style>
            main { 
                width: 100%; 
                max-width: 1100px;
                margin: 0 auto;
                padding: 1rem 2rem 4rem 2rem;
            }
            
            .section-title { 
                font-size: 2.5rem; 
                margin-bottom: 0.5em; 
                text-align: center; 
                font-weight: 800; 
                letter-spacing: -0.02em; 
            }
            .section-desc { text-align: center; color: rgb(var(--gray)); margin-bottom: 3rem; font-size: 1.1rem; }

            .category-grid {
                display: grid;
                grid-template-columns: 1fr 1fr; 
                gap: 2rem;
                padding: 0;
                list-style: none;
            }

            .category-card {
                position: relative;
                display: flex;
                flex-direction: column;
                height: 220px;
                padding: 2rem;
                border-radius: 16px;
                background: linear-gradient(135deg, rgba(var(--card-color-rgb), 0.15) 0%, var(--bg-color) 85%);
                border: 1px solid rgba(var(--gray), 0.2);
                text-decoration: none;
                transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                overflow: hidden;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            }

            .dark .category-card {
                background-color: #171923; 
                background-image: linear-gradient(
                    135deg, 
                    rgba(255, 255, 255, 0.03) 0%, 
                    rgba(var(--card-color-rgb), 0.15) 100%
                );
                border: 1px solid rgba(var(--card-color-rgb), 0.3);
                box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.5);
            }

            .category-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2);
                border-color: rgba(var(--card-color-rgb), 0.6);
                background: linear-gradient(135deg, rgba(var(--card-color-rgb), 0.25) 0%, var(--bg-color) 90%);
            }
            
            .dark .category-card:hover {
                 background-image: linear-gradient(
                    135deg, 
                    rgba(255, 255, 255, 0.05) 0%, 
                    rgba(var(--card-color-rgb), 0.30) 100%
                );
                border-color: rgba(var(--card-color-rgb), 0.6);
                box-shadow: 0 10px 30px -5px rgba(var(--card-color-rgb), 0.15);
            }

            .category-accent {
                position: absolute; top: 0; left: 0; width: 100%; height: 4px;
                background-color: var(--card-color);
                box-shadow: 0 2px 10px var(--card-color);
            }

            .card-icon-bg {
                position: absolute;
                width: 160px;
                height: auto;
                bottom: -20px;
                right: -20px;
                opacity: 0.5;
                transform: rotate(-10deg);
                transition: all 0.4s ease;
                z-index: 0;
                pointer-events: none;
                mix-blend-mode: normal; 
            }

            .dark .card-icon-bg { 
                opacity: 0.6; 
                filter: drop-shadow(0 0 10px rgba(var(--card-color-rgb), 0.3));
            }

            .category-card:hover .card-icon-bg {
                transform: rotate(0deg) scale(1.1);
                opacity: 0.9;
                bottom: -15px;
                right: -15px;
            }

            .category-name {
                font-size: 1.8rem;
                font-weight: 800;
                color: rgb(var(--black));
                margin: 0 0 1rem 0;
                z-index: 1;
                position: relative;
            }
            
            .dark .category-name {
                color: #ffffff;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            }

            /* --- CONTENEDOR DE TAGS --- */
            .card-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 8px; /* Un poco más de espacio */
                max-width: 65%;
                margin-bottom: auto;
                z-index: 1;
                position: relative;
            }

            /* --- ESTILO PILL BYTEBYTEGO --- */
            .mini-tag {
                /* 1. Forma de Píldora Perfecta */
                border-radius: 9999px; 
                padding: 4px 12px;
                
                font-size: 0.75rem;
                font-weight: 700; /* Letra más gordita */
                
                /* 2. Color "Inteligente": Hereda el color de la tarjeta */
                /* Fondo: Color de la categoría con 15% opacidad (Pastel) */
                background-color: rgba(var(--card-color-rgb), 0.15);
                /* Texto: Color de la categoría puro (Brillante/Oscuro) */
                color: var(--card-color);
                
                /* Borde sutil del mismo color */
                border: 1px solid rgba(var(--card-color-rgb), 0.2);
                
                white-space: nowrap;
                transition: all 0.2s ease;
            }

            /* Ajuste específico para Dark Mode para que resalte más */
            .dark .mini-tag {
                background-color: rgba(var(--card-color-rgb), 0.2); /* Un pelín más intenso */
                color: #ffffff; /* Texto blanco para máximo contraste sobre el color */
                border: 1px solid rgba(var(--card-color-rgb), 0.4);
                text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            }

            .article-count {
                font-size: 0.95rem; font-weight: 500; color: rgb(var(--gray));
                display: flex; align-items: center; gap: 8px; z-index: 1; position: relative;
                margin-top: 1rem;
            }
            .arrow-icon {
                opacity: 0; transform: translateX(-10px); transition: all 0.3s ease; color: var(--card-color);
            }
            .category-card:hover .arrow-icon { opacity: 1; transform: translateX(0); }

            a[href*="blue-team"] { --card-color: #3b82f6; --card-color-rgb: 59, 130, 246; }
            a[href*="red-team"], a[href*="pentesting"] { --card-color: #ef4444; --card-color-rgb: 239, 68, 68; }
            a[href*="certificaciones"] { --card-color: #a855f7; --card-color-rgb: 168, 85, 247; }
            a[href*="docencia"], a[href*="teoria"] { --card-color: #f59e0b; --card-color-rgb: 245, 158, 11; }
            a[href*="malware"], a[href*="yara"] { --card-color: #10b981; --card-color-rgb: 16, 185, 129; }

            @media (max-width: 768px) { 
                .category-grid { grid-template-columns: 1fr; } 
                main { padding: 1rem; }
                .card-tags { max-width: 100%; } 
            }
        </style>
    </head>
    <body>
        <Header />
        <main>
            <section>
                <h1 class="section-title">Categorías</h1>
                <p class="section-desc">Selecciona un área para comenzar tu entrenamiento</p>
                
                <div class="category-grid">
                    {
                        sortedCategories.map(([category, count]) => {
                            const slug = slugify(category);
                            const tags = Array.from(categoryTags[category] || []).slice(0, 6);

                            return (
                                <a href={`/category/${slug}/`} class="category-card">
                                    <div class="category-accent"></div>
                                    <img 
                                        class="card-icon-bg" 
                                        src={getCategoryImage(slug)} 
                                        alt="" 
                                    />
                                    
                                    <h2 class="category-name">{category}</h2>
                                    
                                    {/* TAGS SIN ALMOHADILLA # Y ESTILO PILL */}
                                    <div class="card-tags">
                                        {tags.map(tag => (
                                            <span class="mini-tag">{tag}</span>
                                        ))}
                                    </div>

                                    <div class="article-count">
                                        <span>{count} {count === 1 ? 'entrada' : 'entradas'}</span>
                                        <span class="arrow-icon">→</span>
                                    </div>
                                </a>
                            );
                        })
                    }
                </div>
            </section>
        </main>
        <Footer />
    </body>
</html>